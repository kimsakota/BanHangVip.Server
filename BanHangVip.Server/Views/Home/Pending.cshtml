@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@{
    ViewData["Title"] = "Đơn Đang Đợi";
    var currentCustomerId = HttpContextAccessor.HttpContext.Session.GetInt32("CustomerId") ?? 0;
}

<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="fw-bold mb-0">⏳ Đơn Bếp Đang Làm</h5>
            <small class="text-muted">Danh sách món ăn đang được chế biến</small>
        </div>
        <a asp-controller="Home" asp-action="Index" class="btn btn-white text-primary fw-bold rounded-pill shadow-sm border">
            <i class="fa-solid fa-plus-circle me-1"></i> Thêm món mới
        </a>
    </div>

    <div id="pendingList" class="row g-3">
        <div class="col-12 text-center py-5 text-muted">
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <div>Đang tải dữ liệu...</div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const MY_CUSTOMER_ID = @currentCustomerId;
        $(document).ready(() => loadPendingOrders());

        function loadPendingOrders() {
            $.get(`/api/Orders/Pending?customerId=${MY_CUSTOMER_ID}`, data => renderList(data))
             .fail(() => $('#pendingList').html('<div class="col-12 text-center text-danger">Lỗi kết nối server!</div>'));
        }

        function renderList(orders) {
            if (!orders || orders.length === 0) {
                $('#pendingList').html(`<div class="col-12 text-center text-muted py-5"><i class="fa-solid fa-utensils fa-3x mb-3 opacity-25"></i><p>Chưa có đơn nào.</p><a href="/" class="btn btn-sm btn-outline-primary rounded-pill">Gọi món ngay</a></div>`);
                return;
            }

            let html = orders.map(o => {
                let itemsHtml = o.items.map(i => {
                    let itemTotal = 0;

                    let isEstimatedItem = (i.quantity > 0);

                    if (isEstimatedItem && o.status === 0) {
                        itemTotal = 0;
                    }
                    else {
                        if (i.weight > 0 && i.price > 0) itemTotal = i.weight * i.price;
                    }

                    // Tạo chuỗi hiển thị số lượng
                    let qtyStr = "";
                    if (i.quantity > 0) qtyStr += `<b>${i.quantity}</b> con`;
                    if (i.weight > 0) {
                        if (qtyStr) qtyStr += " - ";
                        qtyStr += `<b>${i.weight}</b> kg`;
                    }

                    let isWaiting = (itemTotal === 0);
                    if (isWaiting && i.weight > 0) qtyStr += " <span class='text-muted small fst-italic'>(ước lượng)</span>";

                    let noteHtml = i.note ? `<div class="mt-1 text-danger small fst-italic"><i class="fa-solid fa-fire-burner me-1"></i>${i.note}</div>` : '';

                    return `
                        <div class="d-flex justify-content-between align-items-start mb-2 pb-2 border-bottom border-light">
                            <div>
                                <div class="text-dark">
                                    <span class="fw-bold">${i.productName}</span>
                                    ${isWaiting ? '<span class="badge bg-warning text-dark border border-warning-subtle small ms-2" style="font-size:0.7rem"><i class="fa-solid fa-scale-unbalanced"></i> Chờ cân</span>' : ''}
                                    <div class="small text-muted mt-1">${qtyStr}</div>
                                </div>
                                ${noteHtml}
                            </div>
                            <div class="fw-bold text-primary text-end">
                                <div>${isWaiting ? '---' : formatMoney(itemTotal)}</div>
                            </div>
                        </div>`;
                }).join('');

                let timeStr = new Date(o.createdAt).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                let statusText = o.status === 0 ? "Đang chế biến..." : "Đã xong";

                return `
                <div class="col-12 col-md-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header bg-white border-0 pt-3 d-flex justify-content-between align-items-center">
                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">Đơn #${o.id}</span>
                            <small class="text-muted fw-bold"><i class="fa-regular fa-clock me-1"></i>${timeStr}</small>
                        </div>
                        <div class="card-body pt-0">
                            <div class="mt-2">${itemsHtml}</div>
                            <div class="mt-3 pt-2 text-center">
                                <span class="text-warning fw-bold small bg-warning bg-opacity-10 px-3 py-2 rounded-pill">
                                    <i class="fa-solid fa-bell me-1"></i> ${statusText}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            $('#pendingList').html(html);
        }
        function formatMoney(amount) { return amount.toLocaleString('vi-VN') + ' ₫'; }
    </script>
}