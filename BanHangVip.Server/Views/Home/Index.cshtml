@using Microsoft.AspNetCore.Http
@{
    ViewData["Title"] = "Đặt Hàng Hải Sản";
    var currentCustomerId = Context.Session.GetInt32("CustomerId") ?? 0;
}

<style>
    body {
        background-color: #f0f2f5;
        padding-bottom: 120px;
    }

    .product-card {
        border: none;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        background: white;
        height: 100%;
        transition: transform 0.2s;
        cursor: pointer;
    }

        .product-card:active {
            transform: scale(0.95);
        }

    .product-icon {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }

    .price-tag {
        color: #d63384;
        font-weight: 700;
        font-size: 0.95rem;
    }

    .big-input {
        font-size: 2rem;
        text-align: center;
        border-radius: 12px;
        font-weight: bold;
    }

    .option-btn {
        flex: 1;
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        background: white;
        color: #6c757d;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
    }

        .option-btn.active {
            border-color: #0d6efd;
            background-color: #e7f1ff;
            color: #0d6efd;
        }

    .badge-qty {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ff4757;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .cart-item {
        border-bottom: 1px dashed #eee;
        padding: 10px 0;
    }

    .badge-weight-waiting {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 4px;
        font-weight: bold;
    }
</style>

<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h5 class="fw-bold mb-0">Tạo Đơn Yêu Cầu</h5>
            <small class="text-muted">Chọn món ăn bên dưới</small>
        </div>
        <a asp-controller="Home" asp-action="Pending" class="btn btn-white text-primary fw-bold rounded-pill shadow-sm border">
            <i class="fa-solid fa-hourglass-half me-1"></i> Xem đơn đợi
        </a>
    </div>
    <div id="productList" class="row row-cols-2 row-cols-md-4 g-3"></div>
</div>

<div class="fixed-bottom bg-white shadow p-3 border-top" style="border-radius: 20px 20px 0 0;">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <small class="text-muted d-block">Dự kiến thanh toán</small>
            <h4 class="mb-0 fw-bold text-primary" id="barTotal">0 ₫</h4>
        </div>
        <button class="btn btn-dark rounded-pill px-4 py-2 fw-bold shadow-sm" onclick="showCart()">
            Giỏ Hàng <span class="badge bg-danger ms-2 rounded-pill" id="cartCount">0</span>
        </button>
    </div>
</div>

<div class="modal fade" id="inputModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow" style="border-radius: 20px;">
            <div class="modal-body text-center p-4">
                <div id="modalIcon" style="font-size: 4rem;">🦀</div>
                <h5 class="fw-bold mb-1" id="modalName">Tên Món</h5>
                <div class="text-primary fw-bold mb-3" id="modalPrice"></div>

                <div id="groupOptions" class="mt-3 d-none">
                    <label class="small fw-bold text-muted mb-2">Chọn kiểu làm</label>
                    <div class="d-flex flex-wrap gap-2 justify-content-center" id="optionButtonsArea"></div>

                    <div class="mt-2 position-relative">
                        <input type="text" id="inputCustomPrep" class="form-control text-center rounded-pill" placeholder="Hoặc nhập cách làm khác..." style="font-size: 0.9rem; border: 1px dashed #ccc;">
                    </div>
                </div>

                <div id="groupNote" class="mt-3 d-none text-start">
                    <label class="small fw-bold text-muted mb-1">Ghi chú chế biến</label>
                    <textarea id="inputNote" class="form-control bg-light border-0 fw-bold" rows="2" placeholder="Ví dụ: Nấu canh chua, kho tộ..."></textarea>
                </div>

                <hr class="my-3 opacity-25">

                <div id="groupQuantity" class="mb-3 d-none">
                    <label class="small fw-bold text-muted mb-1">Số lượng (Con)</label>
                    <input type="number" id="inputQty" class="form-control big-input" placeholder="0">
                </div>

                <div id="groupWeight" class="mb-3 d-none">
                    <label class="small fw-bold text-muted mb-1" id="labelWeight">Cân nặng (Kg)</label>
                    <input type="number" id="inputWeight" class="form-control big-input" step="0.1" placeholder="0.0">
                </div>

                <button class="btn btn-primary w-100 rounded-pill py-2 fw-bold mt-2" onclick="addToCart()">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-bottom h-75 rounded-top-4" id="cartOffcanvas">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold">Xác nhận yêu cầu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column bg-light">
        <div id="cartList" class="bg-white rounded-4 p-3 shadow-sm mb-3 overflow-auto flex-grow-1"></div>
        <div class="mt-auto">
            <button class="btn btn-success w-100 py-3 rounded-pill fw-bold shadow" onclick="submitOrder()">🚀 GỬI YÊU CẦU</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const TYPE_WEIGHT = 0;      // Ngao, Sò, Ốc
        const TYPE_QUANTITY = 1;    // Cua
        const TYPE_SEPARATED = 2;   // Cá

        const LOGGED_IN_CUSTOMER_ID = @currentCustomerId;
        let products = [], cart = [], currentProduct = null, selectedOption = "";

        $(document).ready(() => {
            loadProducts();

            // [MỚI] Xử lý sự kiện: Khi gõ vào ô nhập tay -> Bỏ chọn nút
            $('#inputCustomPrep').on('input', function() {
                if($(this).val().trim() !== "") {
                    $('.option-btn').removeClass('active');
                    selectedOption = ""; // Reset nút chọn
                }
            });
        });

        function loadProducts() {
            $.get('/api/Products', data => { products = data; renderGrid(); });
        }

        function renderGrid() {
            let html = products.map(p => `
                <div class="col">
                    <div class="product-card text-center p-3 position-relative" onclick="openModal(${p.id})">
                        ${getBadge(p.id)}
                        <div class="product-icon">${p.icon}</div>
                        <h6 class="fw-bold mb-1 text-truncate">${p.name}</h6>
                        <div class="price-tag">${formatPrice(p.defaultPrice)}</div>
                    </div>
                </div>`).join('');
            $('#productList').html(html);
        }
        function getBadge(pid) {
            let count = cart.filter(x => x.productId === pid).length;
            return count > 0 ? `<div class="badge-qty">${count}</div>` : '';
        }

        function openModal(pid) {
            currentProduct = products.find(p => p.id === pid);
            $('#modalName').text(currentProduct.name);
            $('#modalIcon').html(currentProduct.icon);
            $('#modalPrice').text(formatPrice(currentProduct.defaultPrice) + '/kg');

            // Reset Inputs
            $('#inputQty').val(''); $('#inputWeight').val(''); $('#inputNote').val('');
            $('#inputCustomPrep').val(''); // Reset ô nhập tay

            $('#groupQuantity, #groupWeight, #groupOptions, #groupNote').addClass('d-none');
            selectedOption = "";

            // 1. LOGIC CHỌN CHẾ BIẾN (Hấp, Nướng...)
            if (currentProduct.preparation) {
                let opts = currentProduct.preparation.split(',');
                $('#optionButtonsArea').html(opts.map(o => `<div class="option-btn" onclick="selectOption(this, '${o.trim()}')">${o.trim()}</div>`).join(''));
                $('#groupOptions').removeClass('d-none');
            } else if (currentProduct.saleType === TYPE_SEPARATED) {
                // Cá (nếu ko có preparation list) thì hiện ô nhập ghi chú thường
                $('#groupNote').removeClass('d-none');
            }

            // 2. LOGIC INPUT SỐ LƯỢNG
            if (currentProduct.saleType === TYPE_QUANTITY) { // CUA
                $('#groupQuantity').removeClass('d-none');
                $('#labelWeight').text('Tổng cân ước lượng (Kg)');
                $('#groupWeight').removeClass('d-none');
                setTimeout(() => $('#inputQty').focus(), 500);

            } else if (currentProduct.saleType === TYPE_SEPARATED) { // CÁ
                $('#labelWeight').text('Ước lượng (Kg/con)');
                $('#groupWeight').removeClass('d-none');
                if(!currentProduct.preparation) setTimeout(() => $('#inputWeight').focus(), 500);

            } else { // NGAO SÒ
                $('#labelWeight').text('Khối lượng (Kg)');
                $('#groupWeight').removeClass('d-none');
                setTimeout(() => $('#inputWeight').focus(), 500);
            }
            new bootstrap.Modal('#inputModal').show();
        }

        function selectOption(el, val) {
            $('.option-btn').removeClass('active');
            $(el).addClass('active');
            selectedOption = val;

            // [MỚI] Khi bấm nút -> Xóa ô nhập tay
            $('#inputCustomPrep').val('');

            $('#inputWeight').focus();
        }

        function addToCart() {
            let p = currentProduct;
            let qty = parseInt($('#inputQty').val()) || 0;
            let weight = parseFloat($('#inputWeight').val()) || 0;

            // [MỚI] Logic lấy ghi chú: Ưu tiên nút chọn -> Nếu ko có thì lấy ô nhập tay
            let customPrep = $('#inputCustomPrep').val().trim();

            // Note cuối cùng = Nút chọn HOẶC Nhập tay HOẶC Ghi chú (trường hợp ko có option)
            let finalNote = selectedOption ? selectedOption : (customPrep ? customPrep : $('#inputNote').val());

            // Validate: Nếu sản phẩm YÊU CẦU chọn cách làm (preparation có data)
            // Thì bắt buộc phải có selectedOption HOẶC customPrep
            if (p.preparation && !selectedOption && !customPrep) {
                return alert(`Vui lòng chọn kiểu làm hoặc nhập tay!`);
            }

            let newItem = {
                tempId: Date.now(),
                productId: p.id, productName: p.name, icon: p.icon, price: p.defaultPrice, saleType: p.saleType, note: finalNote,
                quantity: 0, weight: 0, total: 0
            };

            // LOGIC TÍNH TIỀN
            if (p.saleType === TYPE_QUANTITY) { // CUA
                if (qty <= 0) return alert('Vui lòng nhập số con!');
                if (weight <= 0) return alert('Vui lòng nhập ước lượng tổng cân!');
                newItem.quantity = qty;
                newItem.weight = weight;
                newItem.total = 0; // Chờ cân
            }
            else if (p.saleType === TYPE_SEPARATED) { // CÁ
                if (weight <= 0) return alert('Nhập cân nặng ước lượng!');
                newItem.quantity = 1;
                newItem.weight = weight;
                newItem.total = 0; // Chờ cân
            }
            else { // NGAO SÒ
                if (weight <= 0) return alert('Nhập số Kg!');
                newItem.quantity = 0;
                newItem.weight = weight;
                newItem.total = weight * p.defaultPrice;
            }

            if (p.saleType === TYPE_SEPARATED || p.saleType === TYPE_QUANTITY) {
                cart.push(newItem);
            } else {
                let exist = cart.find(x => x.productId === p.id && x.note === newItem.note);
                if (exist) { exist.quantity += newItem.quantity; exist.weight += newItem.weight; exist.total += newItem.total; }
                else cart.push(newItem);
            }

            updateUI();
            bootstrap.Modal.getInstance('#inputModal').hide();
        }

        function showCart() {
            let html = cart.length === 0 ? '<div class="text-center py-5 text-muted">Giỏ hàng trống</div>' :
                cart.map((item, idx) => {
                    let noteHtml = item.note ? `<div class="mt-1"><span class="badge bg-info text-dark border border-info-subtle">${item.note}</span></div>` : '';
                    let desc = '', priceDisplay = '';

                    if (item.saleType === TYPE_QUANTITY) { // CUA
                        desc = `<b>${item.quantity}</b> con &bull; ~${item.weight} kg`;
                        priceDisplay = `<span class="badge bg-warning text-dark">Chờ cân</span>`;
                    }
                    else if (item.saleType === TYPE_SEPARATED) { // CÁ
                        desc = `1 con &bull; ~${item.weight} kg`;
                        priceDisplay = `<span class="badge bg-warning text-dark">Chờ cân</span>`;
                    }
                    else { // NGAO
                        desc = `<b>${item.weight}</b> kg`;
                        priceDisplay = formatPrice(item.total);
                    }

                    return `
                    <div class="cart-item d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-start">
                            <span class="fs-1 me-3 lh-1">${item.icon}</span>
                            <div>
                                <h6 class="fw-bold mb-0">${item.productName}</h6>
                                <div class="text-muted small">${desc}</div>
                                ${noteHtml}
                            </div>
                        </div>
                        <div class="text-end ms-2">
                            <div class="fw-bold text-primary">${priceDisplay}</div>
                            <button class="btn btn-link text-danger text-decoration-none p-0 small" onclick="remove(${idx})">Xóa</button>
                        </div>
                    </div>`;
                }).join('');
            $('#cartList').html(html);
            new bootstrap.Offcanvas('#cartOffcanvas').show();
        }

        function updateUI() {
            $('#cartCount').text(cart.length);
            let total = cart.reduce((sum, item) => sum + item.total, 0);
            $('#barTotal').text(formatPrice(total));
        }
        function remove(idx) { cart.splice(idx, 1); updateUI(); showCart(); }
        function submitOrder() {
            if (cart.length === 0) return;
            if (LOGGED_IN_CUSTOMER_ID === 0) { alert("Vui lòng đăng nhập lại!"); window.location.href = "/Account/Login"; return; }

            let payload = {
                customerId: LOGGED_IN_CUSTOMER_ID,
                items: cart.map(i => ({ productId: i.productId, productName: i.productName, quantity: i.quantity, weight: i.weight, price: i.price, note: i.note }))
            };
            $.ajax({
                url: '/api/Orders', type: 'POST', contentType: 'application/json', data: JSON.stringify(payload),
                success: () => { if(confirm('✅ Đã gửi! Xem đơn đang chờ?')) window.location.href = '/Home/Pending'; else location.reload(); },
                error: () => alert('Lỗi gửi đơn!')
            });
        }
        function formatPrice(num) { return num.toLocaleString('vi-VN') + ' ₫'; }
    </script>
}